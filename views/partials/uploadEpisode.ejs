<!-- uploadEpisode.ejs -->

<div class="page-header">
  <h1 class="main-title">エピソードを追加</h1>
</div>

<!-- ★ 追加成功のメッセージ表示 -->
<% if (created) { %>
  <div class="alert alert-success">
    新しいエピソードを追加しました。さらに追加する場合は下記フォームで続けて登録してください。
  </div>
<% } %>

<div class="page-container"><!-- 2カラムレイアウト -->

  <!-- === 左カラム：フォーム === -->
  <div class="episode-form">
    <h2>新しいエピソードを追加する</h2>
    <p class="section-desc">
      動画ファイル、エピソードタイトル、時間、価格などを入力してください。<br>
      あらすじは任意です。
    </p>

    <form id="episodeForm"
          class="upload-form"
          action="/works/<%= work._id %>/episodes" 
          method="POST" 
          enctype="multipart/form-data">

      <!-- 1) 動画ファイル -->
      <div id="mainDrop" class="drop-full">
        <div class="drop-message">
          <div class="drop-icon">⬆</div>
          <p>ここに動画ファイルをドラッグ＆ドロップ<br>またはクリックしてファイルを選択</p>
        </div>
        <input type="file" id="contentFile" name="contentFile" hidden accept="video/*" required>
      </div>

      <!-- 2) 詳細入力 -->
      <div id="details" class="details hidden">
        <div class="ep-form">

          <!-- エピソードタイトル(必須) -->
          <div class="form-group">
            <label for="title">エピソードタイトル <span style="color: red;">*</span></label>
            <input type="text" id="title" name="title" required>
          </div>

          <!-- あらすじ(任意) -->
          <div class="form-group">
            <label for="description">あらすじ(任意)</label>
            <textarea id="description" name="description" rows="3"></textarea>
          </div>

          <!-- 動画時間(分) -->
          <!-- 必須だけど表示を隠している例(ご要望に合わせて処理) -->
          <div class="form-group" style="display: none;">
            <label for="duration">動画時間（分）</label>
            <input type="number" id="duration" name="duration" min="0" placeholder="例: 24" required>
          </div>

          <!-- 価格(必須) -->
          <div class="form-group">
            <label for="price">価格（円） <span style="color:red;">*</span></label>
            <input type="number" id="price" name="price" min="0" placeholder="0 で無料" required>
          </div>

          <!-- (オプション) 手動でエピソード番号を指定したい時 -->
          <!-- 空の場合は自動で「最後の +1」になります -->
          <div class="form-group">
            <label for="episodeNumber">エピソード番号(任意)</label>
            <input type="number" id="episodeNumber" name="episodeNumber" placeholder="未入力なら自動で最後尾">
          </div>

        </div><!-- /.ep-form -->
      </div><!-- /#details -->

      <!-- 3) 送信ボタン -->
      <button type="submit" class="btn-primary">エピソードを保存</button>

    </form>
  </div><!-- /.episode-form -->


  <!-- === 右カラム：プレビュー === -->
  <aside class="preview-pane">
    <div class="preview-phone-frame">
      <div class="preview-phone-screen">
        
        <!-- ▼ 作品のサムネイル -->
        <div class="preview-thumbnail-wrapper">
          <% if (work.thumbnailUrl) { %>
            <img 
              src="<%= work.thumbnailUrl %>" 
              alt="<%= work.title %>" 
              class="preview-thumbnail">
          <% } else { %>
            <div class="placeholder-overlay">
              作品サムネイルが未設定です
            </div>
          <% } %>
        </div>

        <div class="title-row">
          <div class="preview-title" id="previewTitle"><%= work.title %></div>
          <button type="button" id="toggleExtra" class="extra-toggle-btn">詳細</button>
        </div>

        <dl id="previewExtra" class="preview-extra hidden">
          <dd class="year-label">
            <%= work.releaseDate && work.releaseDate.trim() !== '' 
                 ? work.releaseDate 
                 : '未設定' %>
          </dd>
          <dd class="rating-badge">
            <%= work.rating && work.rating.trim() !== ''
                 ? work.rating
                 : '未設定' %>
          </dd>
          <dt>キャスト</dt>
          <dd><%= work.cast && work.cast.trim() !== '' ? work.cast : '未設定' %></dd>
          <dt>制作</dt>
          <dd><%= work.studio && work.studio.trim() !== '' ? work.studio : '未設定' %></dd>
        </dl>

        <div class="episode-thumb" id="previewArea"></div>

        <div class="episode-info-line clamp-2" id="episodeInfoLine">
          <span id="combinedText"></span>
        </div>

        <div class="toggle-link hidden" id="toggleMore">---続きを見る---</div>

        <div class="episode-extra-line">
          <span class="episode-time" id="previewDuration">0分</span>
          <span class="episode-price" id="previewPrice">無料</span>
        </div>

      </div><!-- /.preview-phone-screen -->
    </div><!-- /.preview-phone-frame -->
  </aside><!-- /preview-pane -->

</div><!-- /.page-container -->


<!-- ★ 追加済みのエピソード一覧を表示したい場合 -->
<% if (episodes && episodes.length) { %>
  <hr>
  <h2>登録済みエピソード一覧</h2>
  <ul>
    <% episodes.forEach(ep => { %>
      <li>
        <strong>Ep <%= ep.episodeNumber %></strong> :
        <%= ep.title %> /
        <%= ep.price %>円
      </li>
    <% }) %>
  </ul>
<% } %>

<!-- 既存のJSはそのまま -->
<script src="/js/uploadEpisode.js"></script>
