<div class="container">
  <!-- â–¼ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰BOX (ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— or é¸æŠ) â–¼ -->
  <div class="upload-box">
    <!-- 1) ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—é ˜åŸŸ (åˆæœŸè¡¨ç¤º) -->
    <div class="upload-section" id="uploadSection">
      <div class="upload-icon">ğŸ¬</div>
      <p>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å‹•ç”»ã‚’é¸æŠ<br>ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
      <button class="select-btn" id="selectBtn">å‹•ç”»ã‚’é¸æŠ</button>
      <input type="file" id="fileInput" accept="video/*" hidden />
    </div>

    <!-- â–¼ é€²æ—è¡¨ç¤ºã‚¨ãƒªã‚¢ â–¼ -->
    <div class="progress-area" id="progressArea" style="display: none;">
      <!-- ã¾ã¨ã‚ã‚‹ãƒ©ãƒƒãƒ‘: .progress-details -->
      <div class="progress-details">
        <p class="uploaded-info" id="uploadedInfo"></p>
        <button class="replace-btn" id="replaceBtnInProgress">å·®ã—æ›¿ãˆã‚‹</button>
      </div>
      <!-- é€²æ—ãƒãƒ¼ -->
      <div class="progress-bar-wrapper">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </div>
  </div>

  <!-- â–¼ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã®ãƒ•ã‚©ãƒ¼ãƒ  & iPhoneãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ â–¼ -->
  <div class="post-container" id="postContainer" style="display: none;">
    <!-- å·¦: å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="description-form">
      <label for="descriptionInput" class="description-label">èª¬æ˜ / #ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°</label>
      <textarea 
        id="descriptionInput" 
        placeholder="#ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’å…¥åŠ›"
      ></textarea>

      <button id="submitBtn" class="submit-btn">æŠ•ç¨¿ã™ã‚‹</button>
    </div>

    <!-- å³: iPhoneé¢¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
    <div class="iphone15-frame">
      <div class="screen" id="screenArea">
        <!-- è¦ªã‚³ãƒ³ãƒ†ãƒŠ: sn-preview-wrapper -->
        <div class="sn-preview-wrapper">
          <video
            id="previewVideo"
            class="sn-preview-video"
            muted
            playsinline
            preload="metadata"
          ></video>
        </div>

        <!-- ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
        <div class="preview-text" id="previewText"></div>

        <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ (ãƒ†ã‚­ã‚¹ãƒˆä¸‹) -->
        <!-- ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸‹ã«ã‚ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼éƒ¨åˆ† -->
<div class="preview-menu" id="previewMenu">
  <ul>
    <li>
      <a href="#">
        <!-- ãƒ­ã‚´(ã‚¢ã‚¤ã‚³ãƒ³)ã¨æ–‡å­— -->
        <span class="menu-icon">ğŸ </span>
        <span class="menu-label">ãƒ›ãƒ¼ãƒ </span>
      </a>
    </li>
    <li>
      <a href="#">
        <span class="menu-icon">ğŸ“</span>
        <span class="menu-label">ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</span>
      </a>
    </li>
    <li>
      <a href="#">
        <span class="menu-icon">ğŸ‘¤</span>
        <span class="menu-label">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</span>
      </a>
    </li>
  </ul>
</div>

      </div>
    </div>
  </div>
</div>



<!-- â–¼ ä½œå“é¸æŠãƒ•ã‚©ãƒ¼ãƒ  ï¼‹ ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰é¸æŠUI å…¨ä½“ãƒ©ãƒƒãƒ‘ -->
<div class="work-section" id="workSelectionBlock">
  <h2>ãƒªãƒ¼ãƒ‰ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é¸æŠ</h2>

  <!-- æ¤œç´¢ãƒãƒ¼ -->
  <div class="work-search-bar">
    <input type="text" id="workSearchInput" placeholder="ä½œå“ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ¤œç´¢..." />
    <button id="workSearchBtn">æ¤œç´¢</button>
  </div>

  <!-- ä½œå“ä¸€è¦§ (ã‚«ãƒ¼ãƒ‰è¡¨ç¤º) -->
  <div id="workList" class="work-list-cards"></div>
  <div class="select-work-button-area">
    <button id="confirmWorkBtn" class="btn-primary" disabled>é¸æŠã™ã‚‹</button>
  </div>
</div>

<!-- â–¼ ä½œå“ç¢ºå®šãƒ¢ãƒ¼ãƒ€ãƒ«: ã€Œã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿã€ -->
<div id="episodeConfirmModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <h4 id="selectedWorkTitle"></h4>
    <p>ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ</p>
    <div class="modal-actions">
      <button id="goAddEpisodeBtn" class="btn-primary">ã¯ã„</button>
      <button id="skipEpisodeBtn"  class="btn-secondary">ã„ã„ãˆ</button>
    </div>
  </div>
</div>

<!-- â–¼ ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«: ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ä¸€è¦§ã‚’ã‚«ãƒ¼ãƒ‰è¡¨ç¤º -->
<div id="episodeSelectModal" class="modal-overlay" style="display:none;">
  <div class="modal-content modal-episode-content">
    <h4>ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’é¸æŠ</h4>
    <div id="episodeList" class="episode-list-cards"></div>
    <div class="select-episode-button-area">
      <button id="decideEpisodeBtn" class="btn-primary" disabled>ã“ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’é¸æŠ</button>
    </div>
  </div>
</div>

<!-- â–¼ é¸æŠå®Œäº†è¡¨ç¤ºãƒ–ãƒ­ãƒƒã‚¯: æœ€åˆã¯éè¡¨ç¤º -->
<div id="selectedContainer" class="selected-container" style="display:none;">
  <h2>ãƒªãƒ¼ãƒ‰ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</h2>
  <p id="selectedStatusText"></p>
  <button id="rechooseBtn" class="btn-secondary">å¤‰æ›´ã™ã‚‹</button>
</div>




<script src="/js/shortNew.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // â–¼ è¦ç´ å–å¾—
    const workSelectionBlock  = document.getElementById('workSelectionBlock');
    const workSearchBtn       = document.getElementById('workSearchBtn');
    const workSearchInput     = document.getElementById('workSearchInput');
    const workList            = document.getElementById('workList');
    const confirmWorkBtn      = document.getElementById('confirmWorkBtn');
  
    const episodeConfirmModal = document.getElementById('episodeConfirmModal');
    const selectedWorkTitle   = document.getElementById('selectedWorkTitle');
    const goAddEpisodeBtn     = document.getElementById('goAddEpisodeBtn');
    const skipEpisodeBtn      = document.getElementById('skipEpisodeBtn');
  
    const episodeSelectModal  = document.getElementById('episodeSelectModal');
    const episodeList         = document.getElementById('episodeList');
    const decideEpisodeBtn    = document.getElementById('decideEpisodeBtn');
  
    const selectedContainer   = document.getElementById('selectedContainer');
    const selectedStatusText  = document.getElementById('selectedStatusText');
    const rechooseBtn         = document.getElementById('rechooseBtn');
  
    // é¸æŠä¸­ã®ä½œå“ãƒ»ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰
    let selectedWorkId    = null;
    let selectedWorkTitleText = '';
    let selectedEpisodeId = null;
    let selectedEpisodeTitle = '';
  
    // =============================
    // (1) ä½œå“æ¤œç´¢ãƒœã‚¿ãƒ³
    // =============================
    workSearchBtn.addEventListener('click', async () => {
      const keyword = workSearchInput.value.trim();
      if (!keyword) {
        alert('æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      try {
        // fetch(`/api/works?q=${keyword}`)
        // ç°¡æ˜“çš„ã«ãƒ‡ãƒ¢
        const res = await fetch(`/api/works?q=${encodeURIComponent(keyword)}`);
        if (!res.ok) throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼');
        const works = await res.json();  
        renderWorkCards(works);
      } catch(err) {
        alert('ä½œå“æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
        console.error(err);
      }
    });
  
    // =============================
    // (2) ä½œå“ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
    // =============================
    function renderWorkCards(worksData) {
      workList.innerHTML = '';
      confirmWorkBtn.disabled = true;
      if (!worksData || worksData.length === 0) {
        workList.innerHTML = '<p>è©²å½“ä½œå“ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }
      worksData.forEach(w => {
        const card = document.createElement('div');
        card.classList.add('work-card');
        const thumb = w.thumbnailUrl || '/img/no_thumbnail.png';
        card.innerHTML = `
          <img src="${thumb}" class="work-card-thumb" alt="${w.title}">
          <div class="work-card-info">
            <h4>${w.title}</h4>
          </div>
        `;
        card.addEventListener('click', () => {
          // é¸æŠãƒˆã‚°ãƒ«
          document.querySelectorAll('.work-card.selected')
                  .forEach(el => el.classList.remove('selected'));
          card.classList.add('selected');
          selectedWorkId        = w._id;
          selectedWorkTitleText = w.title;
          confirmWorkBtn.disabled = false;
        });
        workList.appendChild(card);
      });
    }
  
    // =============================
    // (3) ã€Œé¸æŠã™ã‚‹ã€=> ä½œå“ç¢ºå®šãƒ¢ãƒ¼ãƒ€ãƒ«
    // =============================
    confirmWorkBtn.addEventListener('click', () => {
      if (!selectedWorkId) return;
      selectedWorkTitle.textContent = `ã€${selectedWorkTitleText}ã€ãŒé¸æŠã•ã‚Œã¾ã—ãŸ`;
      episodeConfirmModal.style.display = 'flex';
    });
  
    goAddEpisodeBtn.addEventListener('click', () => {
      episodeConfirmModal.style.display = 'none';
      openEpisodeSelect();
    });
    skipEpisodeBtn.addEventListener('click', () => {
      episodeConfirmModal.style.display = 'none';
      // ä½œå“ã®ã¿é¸æŠå®Œäº†
      finalizeSelection();
    });
  
    // =============================
    // (4) ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ä¸€è¦§ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    // =============================
    async function openEpisodeSelect() {
      try {
        // fetch(`/api/works/${selectedWorkId}/episodes`)
        const res = await fetch(`/api/works/${selectedWorkId}/episodes`);
        if (!res.ok) throw new Error('ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰å–å¾—ã«å¤±æ•—');
        const eps = await res.json();
        renderEpisodeCards(eps);
        episodeSelectModal.style.display = 'flex';
      } catch(err) {
        alert('ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
        console.error(err);
      }
    }
    function renderEpisodeCards(eps) {
      episodeList.innerHTML = '';
      decideEpisodeBtn.disabled = true;
      if (!eps || eps.length===0) {
        episodeList.innerHTML = '<p>ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }
      eps.forEach(ep => {
        const card = document.createElement('div');
        card.classList.add('episode-card');
        const epThumb = ep.thumbnailUrl || '/img/no_thumbnail.png';
        card.innerHTML = `
          <img src="${epThumb}" class="episode-thumb" alt="${ep.title}">
          <div class="episode-card-info"><h4>${ep.title}</h4></div>
        `;
        card.addEventListener('click', () => {
          document.querySelectorAll('.episode-card.selected')
                  .forEach(el => el.classList.remove('selected'));
          card.classList.add('selected');
          selectedEpisodeId    = ep._id;
          selectedEpisodeTitle = ep.title;
          decideEpisodeBtn.disabled = false;
        });
        episodeList.appendChild(card);
      });
    }
  
    // (4)-B ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æœ€çµ‚æ±ºå®š
    decideEpisodeBtn.addEventListener('click', () => {
      episodeSelectModal.style.display = 'none';
      finalizeSelection();
    });
  
    // =============================
    // (5) é¸æŠå®Œäº† => UIåˆ‡ã‚Šæ›¿ãˆ
    // =============================
    function finalizeSelection() {
      // (A) æ¤œç´¢UIã‚’éš ã™
      workSelectionBlock.style.display = 'none';
      // (B) ã€Œä½œå“â—‹â—‹ã€ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰â—‹â—‹ãŒé¸æŠä¸­ã€è¡¨ç¤º
      let msg = `ä½œå“ã€Œ${selectedWorkTitleText}ã€`;
      if (selectedEpisodeTitle) {
        msg += `ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã€Œ${selectedEpisodeTitle}ã€`;
      } else {
        msg += `ï¼ˆã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æœªé¸æŠï¼‰`;
      }
      msg += 'ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™ã€‚';
  
      selectedStatusText.textContent = msg;
      selectedContainer.style.display = 'block';
    }
  
    // (5)-B ã€Œé¸æŠã—ç›´ã™ã€ => UIã‚’ãƒªã‚»ãƒƒãƒˆ
    rechooseBtn.addEventListener('click', () => {
      // (a) é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      selectedWorkId = null;
      selectedWorkTitleText = '';
      selectedEpisodeId = null;
      selectedEpisodeTitle = '';
  
      // (b) ã€Œé¸æŠã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã€è¡¨ç¤ºã‚’éè¡¨ç¤ºã«
      selectedContainer.style.display = 'none';
  
      // (c) æ¤œç´¢ãƒ–ãƒ­ãƒƒã‚¯ã‚’å†è¡¨ç¤º
      workSelectionBlock.style.display = 'block';
  
      // ã‚‚ã—ä½œå“ä¸€è¦§ã‚’ã‚¯ãƒªã‚¢ã—ãŸã‘ã‚Œã°:
      workList.innerHTML = '';
      confirmWorkBtn.disabled = true;
    });
  
    // =============================
    // â–¼ ãƒ‡ãƒ¢ç”¨: æ¤œç´¢çµæœ/ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰
    // =============================
    async function fakeSearchWorks(keyword) {
      // ä¾‹: matches if the title includes 'keyword'
      const allWorks = [
        { _id: 'w001', title: 'é¬¼æ»…ã®åˆƒ', thumbnailUrl: '/img/sampleA.jpg' },
        { _id: 'w002', title: 'é€²æ’ƒã®å·¨äºº', thumbnailUrl: '/img/sampleB.jpg' },
        { _id: 'w003', title: 'å‘ªè¡“å»»æˆ¦', thumbnailUrl: '' },
        { _id: 'w004', title: 'ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹', thumbnailUrl: '/img/sampleC.jpg' },
      ];
      return allWorks.filter(w => w.title.includes(keyword));
    }
    async function fakeFetchEpisodes(workId) {
      // ä¾‹: IDã«å¿œã˜ãŸã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’è¿”ã™
      if (workId === 'w001') {
        return [
          { _id: 'ep001', title: 'ç«ˆé–€ç‚­æ²»éƒ ç«‹å¿—ç·¨', thumbnailUrl: '/img/ep1.jpg' },
          { _id: 'ep002', title: 'é‚£ç”°èœ˜è››å±±ç·¨', thumbnailUrl: '' },
        ];
      } else if (workId === 'w002') {
        return [
          { _id: 'ep010', title: 'å·¨äººè¥²æ¥', thumbnailUrl: '/img/ep2.jpg' },
          { _id: 'ep011', title: 'å£å¤–èª¿æŸ»', thumbnailUrl: '/img/ep3.jpg' },
        ];
      } else {
        return [];
      }
    }
  });
  </script>
  
   